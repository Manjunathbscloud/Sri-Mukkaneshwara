<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fourth Year Deposits (2024-2025) - Sri Mukkanneshwara Associate</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        (function() {
            function hasValidUser() {
                var raw = localStorage.getItem('userDetails') || sessionStorage.getItem('userDetails');
                if (!raw) return false;
                try { var u = JSON.parse(raw); return !!(u && u.id && u.name); } catch(e) { return false; }
            }
            var isAuth = (localStorage.getItem('isAuthenticated') === 'true' || sessionStorage.getItem('isAuthenticated') === 'true') && hasValidUser();
            if (!isAuth) {
                sessionStorage.setItem('returnUrl', window.location.href);
                window.location.href = 'login.html';
            }
        })();
    </script>
</head>
<body>
    <header>
        <h1>Sri Mukkanneshwara Associate</h1>
        <nav>
            <ul>
                <li><a href="index.html">Overview</a></li>
                <li><a href="members.html">Members</a></li>
                <li><a href="login.html">Accounts</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="rules.html">Rules</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="deposits-section">
            <h2 class="page-title"><i class="fas fa-piggy-bank"></i> Deposits 2024-25</h2>

            <div class="info-card">
                <div class="table-header">
                    <h3><i class="fas fa-list-alt"></i> Deposits 2024-25</h3>
                    <div class="table-actions">
                        <button id="downloadPdfBtn" class="download-btn" onclick="downloadDepositsPDF()" title="Download as PDF">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <span class="record-count" id="recordCount">Loading...</span>
                    </div>
                </div>

                <div class="table-container">
                    <table class="member-table deposits-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i> Member</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-rupee-sign"></i> Amount</th>
                                <th><i class="fas fa-tag"></i> Type</th>
                                <th><i class="fas fa-percentage"></i> Interest</th>
                                <th><i class="fas fa-wallet"></i> Balance</th>
                                <th><i class="fas fa-sticky-note"></i> Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="tableLoader" style="display: none;">
                                <td colspan="7" class="table-loader">
                                    <div class="spinner"></div>
                                    <p>Loading deposit data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="info-card no-records" style="display:none;">
                <div class="no-data-content">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" alt="No Records" class="no-data-image">
                    <h3>No Records Found</h3>
                    <p class="no-data-emoji">¯\_(ツ)_/¯</p>
                </div>
            </div>

            <div class="bottom-nav">
                <a href="deposits.html" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Back to Deposits Overview
                </a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Sri Mukkanneshwara Associate. All rights reserved.</p>
    </footer>
    
    <script src="sheets-config.js"></script>
    <script src="sheets-utils.js"></script>
    <script src="deposits-render.js"></script>
    <script>
        // Global variable to store deposit data
        let currentDepositData = [];
        
        // Download PDF function
        async function downloadDepositsPDF() {
            const downloadBtn = document.getElementById('downloadPdfBtn');
            const originalText = downloadBtn.innerHTML;
            
            try {
                // Show loading state
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                downloadBtn.disabled = true;
                
                // Get current deposit data
                const depositData = getCurrentDepositData();
                
                if (!depositData || depositData.length === 0) {
                    alert('No deposit data available to download.');
                    return;
                }
                
                // Generate PDF (you can implement this later)
                console.log('PDF generation for deposits - to be implemented');
                alert('PDF generation feature will be implemented soon!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                // Reset button state
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // Function to get current deposit data
        function getCurrentDepositData() {
            // Try to get data from the table
            const table = document.querySelector('.deposits-table tbody');
            if (!table) return [];
            
            const rows = table.querySelectorAll('tr:not([id="tableLoader"])');
            const depositData = [];
            
            rows.forEach(row => {
                if (row.style.display !== 'none') { // Only include visible rows
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        depositData.push({
                            member_name: cells[0].textContent.trim(),
                            deposit_date: cells[1].textContent.trim(),
                            amount: cells[2].textContent.trim(),
                            deposit_type: cells[3].textContent.trim(),
                            interest_earned: cells[4].textContent.trim(),
                            total_balance: cells[5].textContent.trim(),
                            notes: cells[6].textContent.trim(),
                            year: '2024-25'
                        });
                    }
                }
            });
            
            return depositData;
        }
        
        // Store deposit data when it's loaded
        function onDataLoaded(items) {
            currentDepositData = items;
            
            // Hide loader
            const tableLoader = document.getElementById('tableLoader');
            if (tableLoader) {
                tableLoader.style.display = 'none';
            }
            
            // Update record count
            const recordCount = document.getElementById('recordCount');
            if (recordCount) {
                recordCount.textContent = `${items.length} record${items.length !== 1 ? 's' : ''} found`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Show loader
            const tableLoader = document.getElementById('tableLoader');
            if (tableLoader) {
                tableLoader.style.display = 'table-row';
            }
            
            DepositsRender.loadDeposits('2024-25', { 
                tbodySelector: '.deposits-table tbody',
                onDataLoaded: onDataLoaded
            });
        });
    </script>
</body>
</html>