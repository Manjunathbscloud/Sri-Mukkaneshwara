<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Financial Data Admin - Sri Mukkanneshwara Associate</title>
    <link rel="stylesheet" href="styles.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("SzudKZaiAMaLDKRpt");
        })();
    </script>
    <style>
        .admin-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .admin-form {
            display: grid;
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .update-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .update-btn:hover {
            transform: translateY(-2px);
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .current-data {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .current-data h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Sri Mukkanneshwara Associate</h1>
        <nav>
            <ul>
                <li><a href="index.html">Overview</a></li>
                <li><a href="accounts.html">Accounts</a></li>
                <li><a href="admin-financial.html" style="color: var(--primary);">Financial Admin</a></li>
                <li><a href="#" onclick="logout()" style="color: #e74c3c;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="admin-container">
            <h2><i class="fas fa-calculator"></i> Financial Data Management</h2>
            
            <div class="current-data">
                <h3>Current Financial Data</h3>
                <div class="data-item">
                    <span>Bank Balance:</span>
                    <span id="currentBankBalance">Loading...</span>
                </div>
                <div class="data-item">
                    <span>Available Loan Amount:</span>
                    <span id="currentLoanAmount">Loading...</span>
                </div>
                <div class="data-item">
                    <span>Last Updated:</span>
                    <span id="currentLastUpdated">Loading...</span>
                </div>
                <div class="data-item">
                    <span>Connection Status:</span>
                    <span id="connectionStatus" style="color: #f39c12;">Testing...</span>
                </div>
            </div>

            <form class="admin-form" id="financialForm">
                <div class="form-group">
                    <label for="bankBalance">Bank Balance (₹)</label>
                    <input type="number" id="bankBalance" name="bankBalance" required>
                </div>
                
                <div class="form-group">
                    <label for="availableLoanAmount">Available Loan Amount (₹)</label>
                    <input type="number" id="availableLoanAmount" name="availableLoanAmount" required>
                </div>
                
                <div class="form-group">
                    <label for="lastUpdated">Last Updated Date</label>
                    <input type="date" id="lastUpdated" name="lastUpdated" required>
                </div>
                
                <button type="submit" class="update-btn">
                    <i class="fas fa-save"></i> Update Financial Data
                </button>
            </form>
            
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> Financial data updated successfully!
            </div>
        </div>
    </main>

    <script src="sheets-config.js"></script>
    <script src="js/auth-utils.js"></script>
    <script>
        (function() {
            // Use new AuthUtils for session validation
            if (window.AuthUtils && window.AuthUtils.isSessionValid()) {
                // Session is valid, continue
                return;
            } else {
                // Session is invalid, redirect to login
                sessionStorage.clear();
                sessionStorage.setItem('returnUrl', window.location.href);
                window.location.href = 'login.html';
            }
        })();

        // Check admin access using accounts authentication
        function checkAdminAccess() {
            try {
                console.log('Admin Financial - Checking accounts authentication...');
                
                // Use new AuthUtils for session validation
                if (!window.AuthUtils || !window.AuthUtils.isSessionValid()) {
                    console.log('User not authenticated, redirecting to login');
                    sessionStorage.clear();
                    sessionStorage.setItem('returnUrl', window.location.href);
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Check if user is president (only president has admin access)
                var userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
                var userName = userDetails.name || '';
                
                // Advanced President detection (same as mobile app)
                var isPresident = userName === 'Manjunath Banakar' || 
                                 userName === 'Manjunath' ||
                                 userName.toLowerCase().includes('manjunath');
                
                var isAdmin = userName === 'President' || isPresident;
                
                console.log('User name:', userName, 'Is admin:', isAdmin);
                
                if (!isAdmin) {
                    console.log('User is not admin, redirecting to accounts');
                    alert('Access denied. Admin privileges required.');
                    window.location.href = 'accounts.html';
                    return false;
                }
                
                console.log('Admin authentication successful, allowing access');
                return true;
            } catch (error) {
                console.error('Error checking admin access:', error);
                alert('Access denied. Please login to your account.');
                window.location.href = 'login.html';
                return false;
            }
        }

        // EmailJS will handle member distribution based on your EmailJS configuration

        // Flag to prevent multiple email sends
        let emailSendingInProgress = false;

        // Email notification function
        async function sendFinancialUpdateNotification(oldData, newData, adminName) {
            // Prevent multiple email sends
            if (emailSendingInProgress) {
                console.log('Email sending already in progress, skipping...');
                return;
            }

            try {
                emailSendingInProgress = true;
                console.log('Sending single email notification to all members via EmailJS...');
                
                const templateParams = {
                    admin_name: adminName,
                    update_time: new Date().toLocaleString('en-IN'),
                    old_balance: oldData.bankBalance.toLocaleString('en-IN'),
                    new_balance: newData.bankBalance.toLocaleString('en-IN'),
                    old_loan: oldData.availableLoanAmount.toLocaleString('en-IN'),
                    new_loan: newData.availableLoanAmount.toLocaleString('en-IN'),
                    website_url: 'https://manjunathbscloud.github.io/Sri-Mukkaneshwara/accounts.html'
                };

                // Send single email notification - EmailJS will handle member distribution
                await emailjs.send('service_xl1w3wq', 'template_5j2huil', templateParams);
                console.log('Email notification sent successfully to all members via EmailJS');
                
            } catch (error) {
                console.error('Error sending email notification:', error);
                // Don't show error to user, just log it
            } finally {
                emailSendingInProgress = false;
            }
        }

        // Session Management Functions
        function initializeSessionManagement() {
            // Update last activity on any user interaction
            function updateLastActivity() {
                var now = Date.now().toString();
                sessionStorage.setItem('lastActivity', now);
                localStorage.setItem('lastActivity', now);
            }

            // Track user activity
            ['click', 'keypress', 'scroll', 'mousemove', 'touchstart'].forEach(function(event) {
                document.addEventListener(event, updateLastActivity, true);
            });

            // Check session timeout every 5 minutes
            setInterval(function() {
                var lastActivity = sessionStorage.getItem('lastActivity') || localStorage.getItem('lastActivity');
                var sessionStartTime = sessionStorage.getItem('sessionStartTime') || localStorage.getItem('sessionStartTime');
                
                if (!lastActivity || !sessionStartTime) {
                    var isAuth = sessionStorage.getItem('isAuthenticated') === 'true' || localStorage.getItem('isAuthenticated') === 'true';
                    if (!isAuth) {
                        sessionStorage.clear();
                        localStorage.clear();
                        window.location.href = 'login.html';
                    }
                    return;
                }
                
                var now = Date.now();
                var lastActivityTime = parseInt(lastActivity);
                var sessionStart = parseInt(sessionStartTime);
                
                // Check for 30 minutes of inactivity
                var inactivityTimeout = 30 * 60 * 1000; // 30 minutes
                if (now - lastActivityTime > inactivityTimeout) {
                    alert('Session expired due to inactivity. Please login again.');
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
                
                // Check for total session time (8 hours max)
                var totalSessionTimeout = 8 * 60 * 60 * 1000; // 8 hours
                if (now - sessionStart > totalSessionTimeout) {
                    alert('Session expired. Please login again.');
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
            }, 300000); // Check every 5 minutes

            // Handle page visibility change (tab switching)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Page is hidden, update last activity
                    updateLastActivity();
                }
            });
        }


        // Check access when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAdminAccess()) {
                return; // Stop execution if access is denied
            }
            
            // Initialize session management
            initializeSessionManagement();
            loadCurrentData();
        });

        // Load current financial data from Google Sheets
        async function loadCurrentData() {
            try {
                // Load from Google Sheets
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT0BPMTkSH8oDU7AYQLEcTxN-LHh86WLBMyfZH1eT4ABRCB8vwF2z7BBnzN0-SvaZZ0Apcwkkn08jyw/pub?output=csv');
                const csv = await response.text();
                console.log('CSV Data:', csv);
                
                const rows = csv.split('\n');
                console.log('Rows:', rows);
                
                if (rows.length >= 2) {
                    const headers = rows[0].split(',');
                    const data = rows[1].split(',');
                    
                    console.log('Headers:', headers);
                    console.log('Data:', data);
                    
                    // Clean the data (remove quotes and extra spaces)
                    const bankBalance = parseFloat(data[0].replace(/"/g, '').trim()) || 183790;
                    const availableLoanAmount = parseFloat(data[1].replace(/"/g, '').trim()) || 175000;
                    const lastUpdated = data[2].replace(/"/g, '').trim() || new Date().toISOString().split('T')[0];
                    
                    const currentData = {
                        bankBalance: bankBalance,
                        availableLoanAmount: availableLoanAmount,
                        lastUpdated: lastUpdated
                    };
                    
                    displayCurrentData(currentData);
                    console.log('Current data loaded from Google Sheets:', currentData);
                } else {
                    // Check local storage for fallback data
                    const localData = localStorage.getItem('financialData');
                    if (localData) {
                        try {
                            const parsedData = JSON.parse(localData);
                            const fallbackData = {
                                bankBalance: parsedData.bankBalance || 183790,
                                availableLoanAmount: parsedData.availableLoanAmount || 175000,
                                lastUpdated: parsedData.lastUpdated || new Date().toISOString().split('T')[0]
                            };
                            displayCurrentData(fallbackData);
                            console.log('Using local storage fallback data:', fallbackData);
                            return;
                        } catch (error) {
                            console.error('Error parsing local storage data:', error);
                        }
                    }
                    
                    // Use default values if no data available
                    const defaultData = {
                        bankBalance: 183790,
                        availableLoanAmount: 175000,
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                    displayCurrentData(defaultData);
                }
                
            } catch (error) {
                console.error('Error loading current data:', error);
                alert('Error loading financial data. Using default values.');
                // Use default values if loading fails
                const defaultData = {
                    bankBalance: 183790,
                    availableLoanAmount: 175000,
                    lastUpdated: new Date().toISOString().split('T')[0]
                };
                displayCurrentData(defaultData);
            }
        }
        
        // Display current data
        function displayCurrentData(data) {
            document.getElementById('currentBankBalance').textContent = `₹${data.bankBalance.toLocaleString('en-IN')}`;
            document.getElementById('currentLoanAmount').textContent = `₹${data.availableLoanAmount.toLocaleString('en-IN')}`;
            document.getElementById('currentLastUpdated').textContent = data.lastUpdated;
            
            // Store current data for comparison
            currentFinancialData = {
                bankBalance: data.bankBalance,
                availableLoanAmount: data.availableLoanAmount
            };
            
            // Clear form fields for new input
            document.getElementById('bankBalance').value = '';
            document.getElementById('availableLoanAmount').value = '';
            document.getElementById('lastUpdated').value = new Date().toISOString().split('T')[0];
        }

        // Store current data for comparison
        let currentFinancialData = null;

        // Update financial data - Google Apps Script integration
        async function updateFinancialData(formData) {
            // Show loader
            showLoader();
            
            try {
                // Get user details first
                const userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
                console.log('User details from session:', userDetails);
                
                // Capture old data before update
                const oldData = currentFinancialData || {
                    bankBalance: 183790,
                    availableLoanAmount: 175000
                };
                
                // Update Google Sheet via Google Apps Script
                const params = new URLSearchParams({
                    action: 'updateFinancialData',
                    bankBalance: formData.bankBalance,
                    availableLoanAmount: formData.availableLoanAmount,
                    lastUpdated: formData.lastUpdated
                });
                
                console.log('Updating Google Sheet via Apps Script:', params.toString());
                console.log('Form data being sent:', formData);
                
                // Update Google Sheet via Google Apps Script
                try {
                    const updateUrl = window.SHEETS_CONFIG?.financialUpdateUrl || 'https://script.google.com/macros/s/AKfycbyMSWWzvoAdk4h0LEXuuB0GWiS_M-OjErpUMQqcDoyQlaEEgKQxWOu3tXHjcsNmzF7Y/exec';
                    
                    // Use POST method instead of GET for better data handling
                    const response = await fetch(updateUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params.toString()
                    });
                    
                    console.log('Google Apps Script response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Google Apps Script response:', result);
                        if (result.success) {
                            console.log('Financial data updated successfully in Google Sheet');
                        } else {
                            console.error('Google Apps Script error:', result.message);
                            alert('Error updating Google Sheet: ' + result.message);
                        }
                    } else {
                        console.log('Response not ok, status:', response.status);
                        const errorText = await response.text();
                        console.log('Error response:', errorText);
                        alert('Error connecting to Google Apps Script. Status: ' + response.status);
                    }
                    
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    alert('Error connecting to Google Apps Script: ' + fetchError.message);
                }
                
                console.log('Financial data update completed successfully!');
                
                // Trigger refresh of accounts page data
                window.dispatchEvent(new CustomEvent('financialDataUpdated', {
                    detail: {
                        bankBalance: formData.bankBalance,
                        availableLoanAmount: formData.availableLoanAmount,
                        lastUpdated: formData.lastUpdated
                    }
                }));
                
                // Get admin name from user details (already declared above)
                const adminName = userDetails.name || 'Manjunath Banakar';
                console.log('Admin name for email:', adminName);
                
                // Send email notifications to all members
                await sendFinancialUpdateNotification(oldData, formData, adminName);
                
                // Hide loader
                hideLoader();
                
                // Show success message
                showSuccessMessage();
                
                // Reload current data to show updated values
                await loadCurrentData();
                
                // Trigger refresh on accounts page if it's open
                if (window.opener && window.opener.FinancialData) {
                    window.opener.FinancialData.refresh();
                }
                
            } catch (error) {
                console.error('Error updating financial data:', error);
                hideLoader();
                
                // Show specific error message
                let errorMessage = 'Error updating financial data. Please try again.';
                if (error.message.includes('HTTP error')) {
                    errorMessage = 'Server error occurred. Please check your connection and try again.';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your internet connection.';
                } else if (error.message.includes('userDetails')) {
                    errorMessage = 'Session error. Please refresh the page and try again.';
                }
                
                alert(errorMessage);
                
                // Log detailed error for debugging
                console.error('Detailed error:', {
                    message: error.message,
                    stack: error.stack,
                    formData: formData,
                    userDetails: userDetails
                });
            }
        }
        
        // Show loader
        function showLoader() {
            const loader = document.createElement('div');
            loader.id = 'financialLoader';
            loader.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            loader.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="margin: 0; font-size: 1.1rem; color: #333;">Updating Financial Data...</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            document.body.appendChild(loader);
        }
        
        // Hide loader
        function hideLoader() {
            const loader = document.getElementById('financialLoader');
            if (loader) {
                loader.remove();
            }
        }
        

        // Show success message
        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Handle form submission
        document.getElementById('financialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                const bankBalance = parseInt(document.getElementById('bankBalance').value);
                const availableLoanAmount = parseInt(document.getElementById('availableLoanAmount').value);
                const lastUpdated = document.getElementById('lastUpdated').value;
                
                // Validate form data
                if (!bankBalance || bankBalance <= 0) {
                    alert('Please enter a valid bank balance greater than 0');
                    return;
                }
                
                if (!availableLoanAmount || availableLoanAmount <= 0) {
                    alert('Please enter a valid available loan amount greater than 0');
                    return;
                }
                
                if (!lastUpdated) {
                    alert('Please select a valid date');
                    return;
                }
                
                const formData = {
                    bankBalance: bankBalance,
                    availableLoanAmount: availableLoanAmount,
                    lastUpdated: lastUpdated,
                    notes: "Updated via admin interface"
                };
                
                console.log('Form data validated:', formData);
                updateFinancialData(formData);
                
            } catch (error) {
                console.error('Error in form submission:', error);
                alert('Error processing form data. Please check your inputs and try again.');
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear all session data
                sessionStorage.clear();
                localStorage.clear();
                
                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // Test function to verify Google Apps Script connection
        async function testGoogleAppsScript() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = 'Testing...';
                statusElement.style.color = '#f39c12';
            }
            
            try {
                console.log('Testing Google Apps Script connection...');
                // Test with the financial data script
                const params = new URLSearchParams({
                    action: 'test'
                });
                
                const testUrl = window.SHEETS_CONFIG?.financialUpdateUrl || 'https://script.google.com/macros/s/AKfycbyMSWWzvoAdk4h0LEXuuB0GWiS_M-OjErpUMQqcDoyQlaEEgKQxWOu3tXHjcsNmzF7Y/exec';
                const response = await fetch(`${testUrl}?${params.toString()}`);
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Google Apps Script test successful:', result);
                    if (statusElement) {
                        statusElement.textContent = 'Connected ✓';
                        statusElement.style.color = '#27ae60';
                    }
                    return true;
                } else {
                    console.error('Google Apps Script test failed:', response.status);
                    if (statusElement) {
                        statusElement.textContent = 'Connection Failed ✗';
                        statusElement.style.color = '#e74c3c';
                    }
                    return false;
                }
            } catch (error) {
                console.error('Google Apps Script test error:', error);
                if (statusElement) {
                    statusElement.textContent = 'Connection Error ✗';
                    statusElement.style.color = '#e74c3c';
                }
                return false;
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCurrentData();
            
            // Test Google Apps Script connection
            const isConnected = await testGoogleAppsScript();
            if (!isConnected) {
                console.warn('Google Apps Script connection test failed. Update functionality may not work.');
            }
        });
    </script>
</body>
</html>
