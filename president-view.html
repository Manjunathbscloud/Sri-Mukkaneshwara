<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Applications - President View</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
         <script>
           // Prevent non-presidents from accessing this page
           (function() {
             console.log('President View - Checking authentication...');
             
             // Check both sessionStorage and localStorage for authentication
             var isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true' || localStorage.getItem('isAuthenticated') === 'true';
             var hasUserDetails = sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails');
             
             console.log('Auth check (session + local):', { 
               sessionAuth: sessionStorage.getItem('isAuthenticated'),
               localAuth: localStorage.getItem('isAuthenticated'),
               sessionUser: !!sessionStorage.getItem('userDetails'),
               localUser: !!localStorage.getItem('userDetails'),
               isAuthenticated,
               hasUserDetails: !!hasUserDetails
             });
             
             if (!isAuthenticated || !hasUserDetails) {
               console.log('Not authenticated, redirecting to login');
               var returnUrl = window.location.href;
               sessionStorage.setItem('returnUrl', returnUrl);
               localStorage.setItem('returnUrl', returnUrl);
               window.location.href = 'login.html';
               return;
             }
             
             // Sync session data if needed
             if (sessionStorage.getItem('isAuthenticated') !== 'true' && localStorage.getItem('isAuthenticated') === 'true') {
               console.log('Syncing session data from localStorage');
               sessionStorage.setItem('isAuthenticated', 'true');
               sessionStorage.setItem('userDetails', localStorage.getItem('userDetails'));
               sessionStorage.setItem('role', localStorage.getItem('role'));
               sessionStorage.setItem('isPresident', localStorage.getItem('isPresident'));
             }
             
             // Check if user is president
             var userDetails = null;
             try {
               userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
             } catch(e) {
               console.error('Error parsing user details:', e);
             }
             
             var isPresident = false;
             if (userDetails && userDetails.role) {
               isPresident = userDetails.role.toLowerCase() === 'president';
             } else {
               // Fallback to isPresident flag
               isPresident = sessionStorage.getItem('isPresident') === 'true' || localStorage.getItem('isPresident') === 'true';
             }
             
             console.log('President check:', { isPresident, userDetails });
             
             if (!isPresident) {
               console.log('Not president, redirecting to login');
               var returnUrl = window.location.href;
               sessionStorage.setItem('returnUrl', returnUrl);
               localStorage.setItem('returnUrl', returnUrl);
               window.location.href = 'login.html';
               return;
             }
             
             // Initialize session data if missing
             if (!sessionStorage.getItem('lastActivity')) {
               sessionStorage.setItem('lastActivity', Date.now().toString());
             }
             if (!sessionStorage.getItem('sessionStartTime')) {
               sessionStorage.setItem('sessionStartTime', Date.now().toString());
             }
             
             console.log('Authentication successful, allowing access');
           })();
         </script>

  <div class="container">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
      <div style="margin-bottom: 15px;">
        <a href="accounts.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
          ‚Üê Back to Accounts
        </a>
      </div>
      <h1 style="margin: 0 0 15px 0; font-size: 1.8em; color: #333;">Loan Applications Review</h1>
      <button id="refreshBtn" onclick="loadApplications()" class="btn btn-secondary">
        <i class="fas fa-sync-alt"></i> Refresh Data
      </button>
    </div>

    <!-- Applications Table -->
    <div style="background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <table id="applicationsTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr id="tableHeader" style="background: #f8f9fa;">
            <!-- Headers will be populated by JavaScript -->
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Load sheets configuration - Loan Applications CSV URL
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQR1ymgt-5kh7MOtNkRYSxOy8oAdjohe-02rmgh8je6KHNej6e16iIrhY6pRvtl7gPl5kyTIboJdktj/pub?output=csv";

    function loadApplications() {
      // Add loading indicator
      const tableBody = document.getElementById("tableBody");
      const loadingRow = document.createElement("tr");
      loadingRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading loan applications...</td>';
      tableBody.innerHTML = '';
      tableBody.appendChild(loadingRow);

      fetch(CSV_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(data => {
          console.log('Raw CSV data:', data);
          
          // Clear loading indicator
          tableBody.innerHTML = '';
          
          const rows = data.split("\n").filter(row => row.trim() !== '');
          console.log('Number of rows:', rows.length);
          
          if (rows.length === 0) {
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }

          // Parse CSV properly (handle commas within quoted fields)
          const parseCSV = (csvText) => {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let line of lines) {
              if (line.trim() === '') continue;
              
              const row = [];
              let current = '';
              let inQuotes = false;
              
              for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  row.push(current.trim());
                  current = '';
                } else {
                  current += char;
                }
              }
              row.push(current.trim());
              result.push(row);
            }
            return result;
          };

          const parsedRows = parseCSV(data);
          console.log('Parsed rows:', parsedRows);

          if (parsedRows.length === 0) {
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }

          let headerRow = parsedRows[0];
          console.log('Header row:', headerRow);

          // Map headers to display names (based on actual loan applications sheet structure)
          const headerMap = {
            'timestamp': 'Applied Date',
            'name': 'Applicant Name',
            'email': 'Email',
            'phone': 'Phone',
            'loan amount': 'Loan Amount',
            'reason': 'Reason'
          };

          // Create display headers
          const displayHeaders = headerRow.map(h => headerMap[h.toLowerCase()] || h);
          displayHeaders.push('Actions');

          const tableHeader = document.getElementById("tableHeader");
          
          // Clear existing header
          tableHeader.innerHTML = '';

          // Create table header
          displayHeaders.forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            th.style.padding = '12px';
            th.style.textAlign = 'left';
            th.style.fontWeight = '600';
            th.style.color = '#333';
            th.style.borderBottom = '1px solid #ddd';
            tableHeader.appendChild(th);
          });

          // Create table body
          parsedRows.slice(1).forEach((row, rowIndex) => {
            if (row.length > 1 && row.some(cell => cell.trim() !== '')) { // avoid empty rows
              const tr = document.createElement("tr");
              tr.setAttribute('data-row-index', rowIndex);
              tr.style.borderBottom = '1px solid #eee';

              row.forEach((cell, cellIndex) => {
                const td = document.createElement("td");
                const headerName = headerRow[cellIndex] ? headerRow[cellIndex].toLowerCase() : '';

                // Format timestamp
                if (headerName === 'timestamp') {
                  const date = new Date(cell);
                  if (!isNaN(date.getTime())) {
                    td.textContent = date.toLocaleString('en-IN', {
                      day: '2-digit',
                      month: '2-digit',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                      second: '2-digit',
                      hour12: true
                    });
                  } else {
                    td.textContent = cell;
                  }
                } else if (headerName === 'loan amount') {
                  // Format loan amount
                  const amount = parseFloat(cell.replace(/[‚Çπ,]/g, ''));
                  if (!isNaN(amount)) {
                    td.textContent = `‚Çπ${amount.toLocaleString('en-IN')}`;
                  } else {
                    td.textContent = cell;
                  }
                } else {
                  td.textContent = cell || '-';
                }

                td.style.padding = '12px';
                td.style.borderBottom = '1px solid #eee';
                tr.appendChild(td);
              });

              // Add Accept & Reject buttons
              const actionTd = document.createElement("td");
              actionTd.style.padding = '12px';
              actionTd.style.borderBottom = '1px solid #eee';

              // Find applicant name (Name column)
              const nameIndex = headerRow.findIndex(h => h.toLowerCase() === 'name');
              const applicantName = nameIndex >= 0 ? row[nameIndex] : 'Unknown';
              
              const acceptBtn = document.createElement("button");
              acceptBtn.textContent = "Accept";
              acceptBtn.classList.add('btn', 'btn-success', 'btn-sm');
              acceptBtn.style.marginRight = '5px';
              
              acceptBtn.onclick = () => {
                if (confirm(`Accept loan application for ${applicantName}?`)) {
                  alert(`Loan Accepted for ${applicantName}`);
                  tr.style.backgroundColor = "#d4edda";
                  acceptBtn.disabled = true;
                  rejectBtn.disabled = true;
                  acceptBtn.textContent = "Accepted";
                  rejectBtn.textContent = "Rejected";
                }
              };

              const rejectBtn = document.createElement("button");
              rejectBtn.textContent = "Reject";
              rejectBtn.classList.add('btn', 'btn-danger', 'btn-sm');
              
              rejectBtn.onclick = () => {
                if (confirm(`Reject loan application for ${applicantName}?`)) {
                  alert(`Loan Rejected for ${applicantName}`);
                  tr.style.backgroundColor = "#f8d7da";
                  acceptBtn.disabled = true;
                  rejectBtn.disabled = true;
                  acceptBtn.textContent = "Accepted";
                  rejectBtn.textContent = "Rejected";
                }
              };

              actionTd.appendChild(acceptBtn);
              actionTd.appendChild(rejectBtn);
              tr.appendChild(actionTd);

              tableBody.appendChild(tr);
            }
          });

          // Add summary
          const summaryRow = document.createElement("tr");
          summaryRow.style.backgroundColor = "#e9ecef";
          summaryRow.style.fontWeight = "600";
          summaryRow.innerHTML = `<td colspan="${displayHeaders.length}" style="text-align: center; padding: 10px; border-top: 2px solid #007bff;">Total Applications: ${parsedRows.length - 1}</td>`;
          tableBody.appendChild(summaryRow);

        })
        .catch(error => {
          console.error("Error loading CSV:", error);
          tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #dc3545; background: #f8d7da;">Error loading loan applications. Please try again later.</td></tr>';
        });
    }

    // Load applications when page loads
    loadApplications();
  </script>
</body>
</html>