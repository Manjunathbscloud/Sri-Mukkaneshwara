<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Applications - President View</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
         <script src="js/auth-utils.js"></script>
         <script>
           // Check admin access using accounts authentication
           (function() {
             console.log('President View - Checking accounts authentication...');
             
             // Use new AuthUtils for session validation
             if (!window.AuthUtils || !window.AuthUtils.isSessionValid()) {
               console.log('User not authenticated, redirecting to login');
               sessionStorage.clear();
               sessionStorage.setItem('returnUrl', window.location.href);
               window.location.href = 'login.html';
               return;
             }
             
             // Check if user is president (only president has admin access)
             var userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
             var userName = userDetails.name || '';
             var isAdmin = userName === 'President';
             
             console.log('User name:', userName, 'Is admin:', isAdmin);
             
             if (!isAdmin) {
               console.log('User is not admin, redirecting to accounts');
               alert('Access denied. Admin privileges required.');
               window.location.href = 'accounts.html';
               return;
             }
             
             console.log('Admin authentication successful, allowing access');
           })();
           
  </script>

  <div class="container">
    <!-- Page Header -->
    <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
      <div style="margin-bottom: 15px;">
        <a href="accounts.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
          ← Back to Accounts
        </a>
      </div>
      <h1 style="margin: 0 0 15px 0; font-size: 1.8em; color: #333;">Loan Applications Review</h1>
      <button id="refreshBtn" onclick="loadApplications()" class="btn btn-secondary">
        <i class="fas fa-sync-alt"></i> Refresh Data
      </button>
    </div>

    <!-- Applications Table -->
    <div style="background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <table id="applicationsTable" style="width: 100%; border-collapse: collapse;">
    <thead>
          <tr id="tableHeader" style="background: #f8f9fa;">
            <!-- Headers will be populated by JavaScript -->
          </tr>
    </thead>
        <tbody id="tableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
  </table>
    </div>
  </div>

  <script>
    // Load sheets configuration - Loan Applications CSV URL
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQR1ymgt-5kh7MOtNkRYSxOy8oAdjohe-02rmgh8je6KHNej6e16iIrhY6pRvtl7gPl5kyTIboJdktj/pub?output=csv";

    function loadApplications() {
      // Add loading indicator
      const tableBody = document.getElementById("tableBody");
      const loadingRow = document.createElement("tr");
      loadingRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading loan applications...</td>';
      tableBody.innerHTML = '';
      tableBody.appendChild(loadingRow);

    fetch(CSV_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
      .then(data => {
          console.log('Raw CSV data:', data);
          console.log('Data length:', data.length);
          
          // Clear loading indicator
          tableBody.innerHTML = '';
          
          const rows = data.split("\n").filter(row => row.trim() !== '');
          console.log('Number of rows after filtering:', rows.length);
          console.log('Rows content:', rows);
          
          if (rows.length === 0) {
            console.log('No rows found, showing no data message');
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }

          // Parse CSV properly (handle commas within quoted fields)
          const parseCSV = (csvText) => {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let line of lines) {
              if (line.trim() === '') continue;
              
              const row = [];
              let current = '';
              let inQuotes = false;
              
              for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                  inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                  row.push(current.trim());
                  current = '';
                } else {
                  current += char;
                }
              }
              row.push(current.trim());
              result.push(row);
            }
            return result;
          };

          const parsedRows = parseCSV(data);
          console.log('Parsed rows:', parsedRows);
          console.log('Parsed rows length:', parsedRows.length);

          if (parsedRows.length === 0) {
            console.log('No parsed rows found, showing no data message');
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }

          // Check if we only have headers (1 row) and no actual data
          if (parsedRows.length === 1) {
            console.log('Only header row found, no actual data');
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }

          let headerRow = parsedRows[0];
          console.log('Header row:', headerRow);

          // Map headers to display names (based on actual loan applications sheet structure)
          const headerMap = {
            'timestamp': 'Applied Date',
            'name': 'Applicant Name',
            'email': 'Email',
            'phone': 'Phone',
            'loan amount': 'Loan Amount',
            'reason': 'Reason'
          };

          // Create display headers
          const displayHeaders = headerRow.map(h => headerMap[h.toLowerCase()] || h);
          displayHeaders.push('Actions');

        const tableHeader = document.getElementById("tableHeader");
          
          // Clear existing header
          tableHeader.innerHTML = '';

        // Create table header
          displayHeaders.forEach(header => {
          const th = document.createElement("th");
          th.textContent = header;
            th.style.padding = '12px';
            th.style.textAlign = 'left';
            th.style.fontWeight = '600';
            th.style.color = '#333';
            th.style.borderBottom = '1px solid #ddd';
          tableHeader.appendChild(th);
        });

        // Create table body
          const dataRows = parsedRows.slice(1).filter(row => {
            // Filter out empty rows and rows with only empty cells
            return row.length > 1 && row.some(cell => cell.trim() !== '') && 
                   row.some(cell => cell.trim() !== '' && cell.trim() !== 'undefined' && cell.trim() !== 'null');
          });
          
          console.log('Data rows after filtering:', dataRows);
          console.log('Number of valid data rows:', dataRows.length);
          
          if (dataRows.length === 0) {
            console.log('No valid data rows found after filtering');
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = '<td colspan="7" style="text-align: center; padding: 40px; color: #666;">No loan applications found</td>';
            tableBody.appendChild(noDataRow);
            return;
          }
          
          dataRows.forEach((row, rowIndex) => {
            const tr = document.createElement("tr");
            tr.setAttribute('data-row-index', rowIndex);
            tr.style.borderBottom = '1px solid #eee';

            row.forEach((cell, cellIndex) => {
              const td = document.createElement("td");
              const headerName = headerRow[cellIndex] ? headerRow[cellIndex].toLowerCase() : '';

              // Format timestamp
              if (headerName === 'timestamp') {
                const date = new Date(cell);
                if (!isNaN(date.getTime())) {
                  td.textContent = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  });
                } else {
                  td.textContent = cell;
                }
              } else if (headerName === 'loan amount') {
                // Format loan amount
                const amount = parseFloat(cell.replace(/[₹,]/g, ''));
                if (!isNaN(amount)) {
                  td.textContent = `₹${amount.toLocaleString('en-IN')}`;
                } else {
                  td.textContent = cell;
                }
              } else {
                td.textContent = cell || '-';
              }

              td.style.padding = '12px';
              td.style.borderBottom = '1px solid #eee';
              tr.appendChild(td);
            });

            // Add Accept & Reject buttons
            const actionTd = document.createElement("td");
            actionTd.style.padding = '12px';
            actionTd.style.borderBottom = '1px solid #eee';

            // Find applicant name (Name column)
            const nameIndex = headerRow.findIndex(h => h.toLowerCase() === 'name');
            const applicantName = nameIndex >= 0 ? row[nameIndex] : 'Unknown';

            const acceptBtn = document.createElement("button");
            acceptBtn.textContent = "Accept";
            acceptBtn.classList.add('btn', 'btn-success', 'btn-sm');
            acceptBtn.style.marginRight = '5px';
              
            acceptBtn.onclick = () => {
              if (confirm(`Accept loan application for ${applicantName}?`)) {
                alert(`Loan Accepted for ${applicantName}`);
              tr.style.backgroundColor = "#d4edda";
                acceptBtn.disabled = true;
                rejectBtn.disabled = true;
                acceptBtn.textContent = "Accepted";
                rejectBtn.textContent = "Rejected";
              }
            };

            const rejectBtn = document.createElement("button");
            rejectBtn.textContent = "Reject";
            rejectBtn.classList.add('btn', 'btn-danger', 'btn-sm');
              
            rejectBtn.onclick = () => {
              if (confirm(`Reject loan application for ${applicantName}?`)) {
                alert(`Loan Rejected for ${applicantName}`);
              tr.style.backgroundColor = "#f8d7da";
                acceptBtn.disabled = true;
                rejectBtn.disabled = true;
                acceptBtn.textContent = "Accepted";
                rejectBtn.textContent = "Rejected";
              }
            };

            actionTd.appendChild(acceptBtn);
            actionTd.appendChild(rejectBtn);
            tr.appendChild(actionTd);

            tableBody.appendChild(tr);
          });

          // Add summary
          const summaryRow = document.createElement("tr");
          summaryRow.style.backgroundColor = "#e9ecef";
          summaryRow.style.fontWeight = "600";
          summaryRow.innerHTML = `<td colspan="${displayHeaders.length}" style="text-align: center; padding: 10px; border-top: 2px solid #007bff;">Total Applications: ${dataRows.length}</td>`;
          tableBody.appendChild(summaryRow);

        })
        .catch(error => {
          console.error("Error loading CSV:", error);
          tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #dc3545; background: #f8d7da;">Error loading loan applications. Please try again later.</td></tr>';
        });
    }

    // Load applications when page loads
    loadApplications();
  </script>
</body>
</html>