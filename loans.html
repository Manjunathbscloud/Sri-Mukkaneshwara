<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loans - Sri Mukkanneshwara Associate</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    /* Font adjustments for loan summary */
    .summary-card .summary-label {
      font-size: 1rem;
      font-weight: 500;
      color: #555;
    }
    
    .summary-card .summary-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #2c3e50;
      margin-top: 0.25rem;
    }
    
    .summary-card h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    
    @media screen and (max-width: 768px) {
      .summary-card .summary-value {
        font-size: 1.5rem;
      }
      
      .summary-card .summary-label {
        font-size: 0.9rem;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="js/auth-utils.js"></script>
  <script>
    (function() {
      // Wait for AuthUtils to be available, check multiple times
      function checkAuth() {
        // Try to use AuthUtils if available
        if (window.AuthUtils && typeof window.AuthUtils.isSessionValid === 'function') {
          if (window.AuthUtils.isSessionValid()) {
            // Sync sessionStorage if needed
            var user = window.AuthUtils.getCurrentUser();
            if (user && !sessionStorage.getItem('userDetails')) {
              sessionStorage.setItem('userDetails', JSON.stringify(user));
            }
            return; // Session is valid, continue
          }
        } else {
          // AuthUtils not loaded yet, wait a bit and try again
          setTimeout(checkAuth, 100);
          return;
        }
        
        // Fallback: Check both sessionStorage and localStorage manually
        var userDetails = sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails');
        if (userDetails) {
          try {
            var user = JSON.parse(userDetails);
            if (user && (user.name || user.email)) {
              // Valid user found, sync to sessionStorage
              sessionStorage.setItem('userDetails', userDetails);
              return; // Session is valid, continue
            }
          } catch(e) {
            console.error('Error parsing user details:', e);
          }
        }
        
        // No valid session found, redirect to login
        sessionStorage.setItem('returnUrl', window.location.href);
        window.location.href = 'login.html';
      }
      
      // Start checking immediately
      checkAuth();
    })();
  </script>
</head>
<body>
  <header>
    <h1>Sri Mukkanneshwara Associate</h1>
    <nav>
      <ul>
        <li><a href="main.html">Overview</a></li>
        <li><a href="members.html">Members</a></li>
        <li><a href="accounts.html">Accounts</a></li>
        <li><a href="meetings.html">Meetings</a></li>
        <li><a href="rules.html">Rules</a></li>
      </ul>
    </nav>
    
    <!-- User Details in Top Right -->
    <div class="user-header-info" id="userHeaderInfo" style="display: none;">
        <div class="user-avatar-small">
            <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-details-small">
            <span class="user-name" id="headerUserName">Loading...</span>
            <span class="user-role" id="headerUserRole">Loading...</span>
        </div>
        <div class="user-dropdown">
            <button class="user-menu-btn" onclick="toggleUserMenu()">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="user-menu" id="userMenu" style="display: none;">
                <a href="accounts.html"><i class="fas fa-user"></i> My Account</a>
                <a href="#" id="logoutBtn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </div>
  </header>

  <main>
    <section class="loans-section">
      <div class="header-with-nav">
        <div style="text-align: left;">
          <a href="accounts.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
            ← Back to Accounts
          </a>
        </div>
        <h2 class="page-title"><i class="fas fa-hand-holding-usd"></i> Loans</h2>
        <div style="text-align: right;">
          <a href="deposits.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
            View Deposits →
          </a>
        </div>
      </div>

      <!-- Summary Section -->
      <div class="info-card summary-card">
        <h3>Loan Summary 2025-26</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Total Loan</span>
            <span class="summary-value" id="totalLoanAmount">Loading...</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Active Members</span>
            <span class="summary-value" id="numberOfMembers">Loading...</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Interest</span>
            <span class="summary-value" id="totalInterest">Loading...</span>
          </div>
        </div>
      </div>


      <!-- Year Links Section -->
      <div class="info-card">
        <h3>Yearly Records</h3>
        <div class="year-links">
          <a href="loans-2021.html" class="year-link">
            <span class="year">2021-2022</span>
            <span class="details">First Year Records</span>
          </a>
          <a href="loans-2022.html" class="year-link">
            <span class="year">2022-2023</span>
            <span class="details">Second Year Records</span>
          </a>
          <a href="loans-2023.html" class="year-link">
            <span class="year">2023-2024</span>
            <span class="details">Third Year Records</span>
          </a>
          <a href="loans-2024.html" class="year-link">
            <span class="year">2024-2025</span>
            <span class="details">Fourth Year Records</span>
          </a>
          <a href="loans-2025.html" class="year-link current-year">
            <span class="year">2025-2026</span>
            <span class="details">Fifth Year Records</span>
            <span class="active-badge">Active</span>
          </a>
        </div>
      </div>


      <!-- Note Section -->
      <div class="info-card note-card">
        <div class="important-note">
          <i class="fas fa-info-circle"></i>
          <p>Note: All records and calculations shown are up to the Annual Meeting (October 2025). Updates will be made after the meeting.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2024 Sri Mukkanneshwara Associate. All rights reserved.</p>
  </footer>
  <script src="sheets-config.js"></script>
  <script src="sheets-utils.js"></script>
  <script src="loans-render.js"></script>
  <script>
    // Load loan summary data for 2025-26
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Loading loan summary data for 2025-26...');
      
      // Load loans data for 2025-26
      if (window.LoansRender) {
        // Fetch the data directly
        async function loadLoanSummary() {
          try {
            if (!window.SHEETS_CONFIG || !window.SHEETS_CONFIG.loansCsvUrl) {
              console.warn('Missing loansCsvUrl in SHEETS_CONFIG');
              return;
            }
            
            const csv = await window.SheetsUtils.fetchCsv(window.SHEETS_CONFIG.loansCsvUrl);
            const rows = window.SheetsUtils.parseCsv(csv);
            const items = window.SheetsUtils.rowsToObjects(rows);
            const filtered = items.filter(r => String(r.year).trim() === '2025-26');
            
            // Calculate summary statistics
            const activeLoans = filtered.filter(loan => {
              const status = (loan.status || '').toLowerCase();
              return status === 'active';
            });
            
            // Helper function to parse currency values
            function parseCurrency(value) {
              if (!value) return 0;
              const raw = value.toString().replace(/[,\s₹]/g, '');
              const num = raw === '' ? NaN : Number(raw);
              return Number.isFinite(num) ? num : 0;
            }
            
            // Calculate total active loans amount
            const totalActiveAmount = activeLoans.reduce((sum, loan) => {
              return sum + parseCurrency(loan.amount);
            }, 0);
            
            // Calculate total loan amount (only active loans)
            const totalLoanAmount = activeLoans.reduce((sum, loan) => {
              return sum + parseCurrency(loan.amount);
            }, 0);
            
            // Calculate total interest (only active loans)
            const totalInterest = activeLoans.reduce((sum, loan) => {
              return sum + parseCurrency(loan.interest);
            }, 0);
            
            // Calculate total amount paid (all loans)
            const totalAmountPaid = filtered.reduce((sum, loan) => {
              return sum + parseCurrency(loan.total_paid);
            }, 0);
            
            // Get unique members with active loans
            const uniqueMembers = [...new Set(activeLoans.map(loan => loan.member).filter(m => m && m.trim()))];
            
            // Update the summary display
            const totalLoanAmountElement = document.getElementById('totalLoanAmount');
            const numberOfMembersElement = document.getElementById('numberOfMembers');
            const totalInterestElement = document.getElementById('totalInterest');
            
            if (totalLoanAmountElement) {
              totalLoanAmountElement.textContent = window.SheetsUtils.currency(totalLoanAmount);
            }
            
            if (numberOfMembersElement) {
              numberOfMembersElement.textContent = uniqueMembers.length.toString();
            }
            
            if (totalInterestElement) {
              totalInterestElement.textContent = window.SheetsUtils.currency(totalInterest);
            }
            
            console.log('Loan summary updated:', {
              totalActiveAmount,
              totalLoanAmount,
              totalInterest,
              totalAmountPaid,
              numberOfMembers: uniqueMembers.length,
              activeLoans: activeLoans.length,
              totalLoans: filtered.length
            });
            
          } catch (error) {
            console.error('Error loading loan summary:', error);
          }
        }
        
        loadLoanSummary();
      }
    });
  </script>
  
  <!-- User Header Script -->
  <script src="js/user-header.js"></script>
  <script>
    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear all session data
        sessionStorage.clear();
        localStorage.clear();
        
        // Redirect to login page
        window.location.href = 'login.html';
      }
    }

    // Show user header if logged in
    document.addEventListener('DOMContentLoaded', function() {
      const userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
      const userHeaderInfo = document.getElementById('userHeaderInfo');
      const headerUserName = document.getElementById('headerUserName');
      const headerUserRole = document.getElementById('headerUserRole');
      
      if (userDetails && userDetails.name) {
        userHeaderInfo.style.display = 'flex';
        headerUserName.textContent = userDetails.name;
        headerUserRole.textContent = userDetails.name === 'President' ? 'President' : 'Member';
        console.log('User header displayed for:', userDetails.name);
      }
    });
  </script>
</body>
</html>
