<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2021-22 Loans - Sri Mukkanneshwara Associate</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Enhanced table styling for loans-2021 */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .table-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.25rem;
        }
        
        .table-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .record-count {
            background: #f8f9fa;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loans-table {
            margin: 0;
            min-width: 800px;
        }
        
        .loans-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            white-space: nowrap;
        }
        
        .loans-table th i {
            margin-right: 0.5rem;
            opacity: 0.8;
        }
        
        .loans-table td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        
        .loans-table tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .loans-table tr.completed {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .loans-table tr.completed:hover {
            background-color: #e9ecef;
        }
        
        .loan-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .status-clear, .status-active {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-clear {
            background: #d4edda;
            color: #155724;
        }
        
        .status-active {
            background: #cce5ff;
            color: #004085;
        }
        
        .total-row {
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%) !important;
            font-weight: bold;
            border-top: 3px solid #2c3e50;
        }
        
        .total-row td {
            padding: 1rem 0.75rem;
            font-size: 1.1rem;
        }
        
        .total-row td:first-child {
            text-align: right;
            color: #2c3e50;
        }
        
        .total-row td:last-child {
            color: #28a745;
            font-size: 1.2rem;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .loans-table {
                font-size: 0.85rem;
            }
            
            .loans-table th,
            .loans-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Sri Mukkanneshwara Associate</h1>
        <nav>
            <ul>
                <li><a href="index.html">Overview</a></li>
                <li><a href="members.html">Members</a></li>
                <li><a href="accounts.html">Accounts</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="rules.html">Rules</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <script>
            (function() {
                function hasValidUser() {
                    var raw = localStorage.getItem('userDetails') || sessionStorage.getItem('userDetails');
                    if (!raw) return false;
                    try { var u = JSON.parse(raw); return !!(u && u.id && u.name); } catch(e) { return false; }
                }
                var isAuth = (localStorage.getItem('isAuthenticated') === 'true' || sessionStorage.getItem('isAuthenticated') === 'true') && hasValidUser();
                if (!isAuth) {
                    sessionStorage.setItem('returnUrl', window.location.href);
                    window.location.href = 'login.html';
                }
            })();
        </script>
        <section class="loans-section">
            <h2 class="page-title"><i class="fas fa-hand-holding-usd"></i> Loans 2021-22</h2>


            <div class="info-card">
                <div class="table-header">
                    <h3><i class="fas fa-list-alt"></i> Loan List 2021-22</h3>
                    <div class="table-actions">
                    <button id="downloadPdfBtn" class="download-btn" onclick="downloadLoanPDF()" title="Download as PDF">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                        <span class="record-count" id="recordCount">Loading...</span>
                </div>
                
                <!-- Active Filter Badges -->
                <div class="filter-badges" id="filterBadges" style="display: none;">
                    <!-- Filter badges will be dynamically added here -->
                </div>
                </div>
                <!-- Floating Filter Dropdowns -->
                <div class="floating-filters">
                    <div class="member-filter-dropdown" id="memberFilterDropdown" style="display: none;">
                        <div class="filter-options">
                        </div>
                    </div>
                    <div class="status-filter-dropdown" id="statusFilterDropdown" style="display: none;">
                        <div class="filter-options">
                            <div class="filter-option clear-filter" onclick="selectStatusFilter('')">Clear Filter</div>
                            <div class="filter-option" onclick="selectStatusFilter('active')">Active</div>
                            <div class="filter-option" onclick="selectStatusFilter('clear')">Clear</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="member-table loans-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> Loan ID</th>
                                <th>
                                    <i class="fas fa-user"></i> Member <i class="fas fa-chevron-down filter-arrow" id="memberArrow" onclick="toggleMemberFilter()"></i>
                                </th>
                                <th><i class="fas fa-calendar"></i> From</th>
                                <th><i class="fas fa-rupee-sign"></i> Amount</th>
                                <th><i class="fas fa-percentage"></i> Interest</th>
                                <th><i class="fas fa-calendar-check"></i> Renewal</th>
                                <th>
                                    <i class="fas fa-info-circle"></i> Status <i class="fas fa-chevron-down filter-arrow" id="statusArrow" onclick="toggleStatusFilter()"></i>
                                </th>
                                <th><i class="fas fa-money-bill-wave"></i> Total Paid</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="info-card no-records" style="display:none;">
                <div class="no-data-content">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" alt="No Records" class="no-data-image">
                    <h3>No Records Found</h3>
                    <p class="no-data-emoji">¬Ø\_(„ÉÑ)_/¬Ø</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <a href="loans.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
                    ‚Üê Back to Loans Overview
                </a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Sri Mukkanneshwara Associate. All rights reserved.</p>
    </footer>
    <script src="sheets-config.js"></script>
    <script src="sheets-utils.js"></script>
    <script src="loans-render.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script>
        // Table filtering functionality
        let allTableData = [];
        let selectedMemberFilter = '';
        let selectedStatusFilter = '';

        // Toggle member filter dropdown
        function toggleMemberFilter() {
            const memberDropdown = document.getElementById('memberFilterDropdown');
            const statusDropdown = document.getElementById('statusFilterDropdown');
            const memberArrow = document.getElementById('memberArrow');
            
            // Close status dropdown if open
            statusDropdown.style.display = 'none';
            
            // Toggle member dropdown
            if (memberDropdown.style.display === 'none') {
                // Position dropdown relative to the member column
                const memberHeader = memberArrow.closest('th');
                const rect = memberHeader.getBoundingClientRect();
                const tableContainer = document.querySelector('.table-container');
                const containerRect = tableContainer.getBoundingClientRect();
                
                // Calculate position relative to table container
                const left = rect.left - containerRect.left;
                const top = rect.bottom - containerRect.top + 5;
                
                memberDropdown.style.position = 'absolute';
                memberDropdown.style.left = left + 'px';
                memberDropdown.style.top = top + 'px';
                memberDropdown.style.display = 'block';
                memberDropdown.style.zIndex = '1000';
                
                populateMemberFilter();
            } else {
                memberDropdown.style.display = 'none';
            }
        }

        // Toggle status filter dropdown
        function toggleStatusFilter() {
            const memberDropdown = document.getElementById('memberFilterDropdown');
            const statusDropdown = document.getElementById('statusFilterDropdown');
            
            // Close member dropdown if open
            memberDropdown.style.display = 'none';
            
            // Toggle status dropdown
            if (statusDropdown.style.display === 'none') {
                statusDropdown.style.display = 'block';
            } else {
                statusDropdown.style.display = 'none';
            }
        }

        // Populate member filter dropdown
        function populateMemberFilter() {
            const memberDropdown = document.getElementById('memberFilterDropdown');
            const filterOptions = memberDropdown.querySelector('.filter-options');
            
            // Clear existing options
            filterOptions.innerHTML = '';
            
            // Add "Clear Filter" option
            const clearOption = document.createElement('div');
            clearOption.className = 'filter-option clear-filter';
            clearOption.textContent = 'Clear Filter';
            clearOption.onclick = () => selectMemberFilter('');
            filterOptions.appendChild(clearOption);
            
            // Get unique member names from table data
            const uniqueMembers = [...new Set(allTableData.map(loan => loan.member).filter(name => name))];
            
            // Add member options
            uniqueMembers.forEach(member => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.textContent = member;
                option.onclick = () => selectMemberFilter(member);
                filterOptions.appendChild(option);
            });
        }

        // Select member filter
        function selectMemberFilter(member) {
            selectedMemberFilter = member;
            document.getElementById('memberFilterDropdown').style.display = 'none';
            applyFilters();
        }

        // Select status filter
        function selectStatusFilter(status) {
            selectedStatusFilter = status;
            document.getElementById('statusFilterDropdown').style.display = 'none';
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            // Filter table rows based on selected criteria
            const tableRows = document.querySelectorAll('.loans-table tbody tr');
            
            tableRows.forEach(row => {
                const memberCell = row.cells[1]; // Member column (index 1)
                const statusCell = row.cells[6]; // Status column (index 6)
                
                if (!memberCell || !statusCell) return;
                
                const memberText = memberCell.textContent.toLowerCase().trim();
                const statusText = statusCell.textContent.toLowerCase().trim();
                
                // Check member filter
                const memberMatch = !selectedMemberFilter || 
                    memberText.includes(selectedMemberFilter.toLowerCase());
                
                // Check status filter
                const statusMatch = !selectedStatusFilter || 
                    statusText.includes(selectedStatusFilter.toLowerCase());
                
                // Show/hide row based on filters
                if (memberMatch && statusMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update record count
            const visibleRows = document.querySelectorAll('.loans-table tbody tr:not([style*="display: none"])');
            const recordCount = document.getElementById('recordCount');
            if (recordCount) {
                recordCount.textContent = `${visibleRows.length} record${visibleRows.length !== 1 ? 's' : ''} found`;
            }
            
            // Update total interest for visible rows
            updateTotalInterest();
            
            // Update visual indicators
            updateFilterIndicators();
        }

        // Update total interest and amount based on visible rows
        function updateTotalInterest() {
            const visibleRows = document.querySelectorAll('.loans-table tbody tr:not([style*="display: none"])');
            const table = document.querySelector('.loans-table');
            const tfoot = table.querySelector('tfoot');
            
            if (!tfoot) return;
            
            // Calculate total interest from visible rows only
            let totalInterest = 0;
            let totalAmount = 0;
            
            // Get all table rows (including hidden ones)
            const allTableRows = document.querySelectorAll('.loans-table tbody tr');
            
            allTableRows.forEach(row => {
                // Check if row is visible (not filtered out)
                const isVisible = row.style.display !== 'none';
                
                if (isVisible && row.cells.length >= 8) {
                    // Calculate total interest (Total Paid column - index 7)
                    const totalPaidCell = row.cells[7];
                    if (totalPaidCell) {
                        const totalPaidText = totalPaidCell.textContent.trim();
                        const totalPaidValue = parseFloat(totalPaidText.replace(/[‚Çπ,\s]/g, '')) || 0;
                        totalInterest += totalPaidValue;
                    }
                    
                    // Calculate total amount (Amount column - index 4)
                    const amountCell = row.cells[4];
                    if (amountCell) {
                        const amountText = amountCell.textContent.trim();
                        const amountValue = parseFloat(amountText.replace(/[‚Çπ,\s]/g, '')) || 0;
                        totalAmount += amountValue;
                    }
                }
            });
            
            // Update the total interest in the footer
            const totalRows = tfoot.querySelectorAll('tr');
            
            // Update Total Interest (second row)
            if (totalRows.length >= 2) {
                const interestTd = totalRows[1].cells[1]; // Total Interest column
                if (interestTd) {
                    interestTd.innerHTML = `<strong>‚Çπ${totalInterest.toLocaleString('en-IN')}</strong>`;
                }
            }
            
            // Don't show Total Amount row - only show Total Interest
        }

        // Update filter indicators
        function updateFilterIndicators() {
            const filterBadges = document.getElementById('filterBadges');
            const memberArrow = document.getElementById('memberArrow');
            const statusArrow = document.getElementById('statusArrow');
            
            // Clear existing content
            filterBadges.innerHTML = '';
            
            // Check if any filters are active
            const hasActiveFilters = selectedMemberFilter || selectedStatusFilter;
            
            if (hasActiveFilters) {
                filterBadges.style.display = 'block';
                
                // Create styled text display for filters
                let filterText = '<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px 16px; margin: 10px 0; font-size: 0.9rem; color: #495057;">';
                filterText += '<strong style="color: #6c757d;">üìã Applied Filters:</strong> ';
                
                const filters = [];
                
                if (selectedMemberFilter) {
                    filters.push(`<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-weight: 500;">üë§ ${selectedMemberFilter}</span>`);
                }
                if (selectedStatusFilter) {
                    filters.push(`<span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-weight: 500;">üîç ${selectedStatusFilter}</span>`);
                }
                
                filterText += filters.join(' ');
                
                // Add clear all button
                filterText += ' <a href="#" onclick="clearAllFilters(); return false;" style="background: #dc3545; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-weight: 500; margin-left: 10px; display: inline-block;">üóëÔ∏è Clear All</a>';
                filterText += '</div>';
                
                filterBadges.innerHTML = filterText;
            } else {
                filterBadges.style.display = 'none';
            }
            
            // Update arrow styles
            if (selectedMemberFilter) {
                memberArrow.classList.add('active-filter');
            } else {
                memberArrow.classList.remove('active-filter');
            }
            
            if (selectedStatusFilter) {
                statusArrow.classList.add('active-filter');
            } else {
                statusArrow.classList.remove('active-filter');
            }
        }

        // Clear member filter
        function clearMemberFilter() {
            selectedMemberFilter = '';
            applyFilters();
        }

        // Clear status filter
        function clearStatusFilter() {
            selectedStatusFilter = '';
            applyFilters();
        }

        // Clear all filters
        function clearAllFilters() {
            selectedMemberFilter = '';
            selectedStatusFilter = '';
            applyFilters();
        }

        // Store original data when data is loaded
        function onDataLoaded(items) {
            allTableData = items;
            
                    // Update record count
                    const recordCount = document.getElementById('recordCount');
                    if (recordCount) {
                        recordCount.textContent = `${items.length} record${items.length !== 1 ? 's' : ''} found`;
                    }
                }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const memberDropdown = document.getElementById('memberFilterDropdown');
            const statusDropdown = document.getElementById('statusFilterDropdown');
            const memberArrow = document.getElementById('memberArrow');
            const statusArrow = document.getElementById('statusArrow');
            
            if (!memberDropdown.contains(event.target) && !memberArrow.contains(event.target)) {
                memberDropdown.style.display = 'none';
            }
            
            if (!statusDropdown.contains(event.target) && !statusArrow.contains(event.target)) {
                statusDropdown.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            LoansRender.loadLoans('2021-22', { 
                tbodySelector: '.loans-table tbody',
                onDataLoaded: onDataLoaded
            });
        });

        // PDF Download functionality
        async function downloadLoanPDF() {
            const downloadBtn = document.getElementById('downloadPdfBtn');
            const originalText = downloadBtn.innerHTML;
            
            try {
                // Show loading state
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                downloadBtn.disabled = true;
                
                // Get current loan data
                const loanData = getCurrentLoanData();
                
                if (loanData.length === 0) {
                    alert('No data available to generate PDF');
                    return;
                }
                
                // Generate PDF
                const success = await PDFGenerator.generateLoanPDF('2021-22', loanData, 'Loan Records 2021-22');
                
                if (success) {
                    console.log('PDF generated successfully');
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                // Reset button state
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // Function to get current loan data
        function getCurrentLoanData() {
            // Try to get data from the table
            const table = document.querySelector('.loans-table tbody');
            if (!table) return [];
            
            const rows = table.querySelectorAll('tr');
            const loanData = [];
            
            rows.forEach(row => {
                if (row.style.display !== 'none') { // Only include visible rows
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        loanData.push({
                            loan_id: cells[0].textContent.trim(),
                            member: cells[1].textContent.trim(),
                            from: cells[2].textContent.trim(),
                            amount: cells[3].textContent.trim(),
                            interest: cells[4].textContent.trim(),
                            renewal_or_return_month: cells[5].textContent.trim(),
                            status: cells[6].textContent.trim(),
                            total_paid: cells[7].textContent.trim(),
                            year: '2021-22'
                        });
                    }
                }
            });
            
            return loanData;
        }
    </script>
</body>
</html> 