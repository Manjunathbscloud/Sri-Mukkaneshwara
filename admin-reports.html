<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Sri Mukkanneshwara Associate</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .reports-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .reports-header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .reports-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .chart-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .data-table h3 {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            margin: 0;
            font-size: 1.2rem;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .back-to-admin {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e1e5e9;
        }
        
        .back-to-admin a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-to-admin a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #e74c3c;
            background: #fdf2f2;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <!-- Reports Header -->
        <div class="reports-header">
            <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
            <p>Comprehensive financial analysis and member activity insights</p>
        </div>
        
        
        <!-- Simple Deposits and Interest Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i> Deposits and Interest Analysis
            </div>
            <div class="chart-wrapper">
                <canvas id="simpleDepositsChart"></canvas>
            </div>
            
            <!-- Meeting Calculation Info -->
            <div style="background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin-top: 20px; border-radius: 0 8px 8px 0; font-style: italic; color: #6c757d;">
                <i class="fas fa-info-circle" style="color: #007bff; margin-right: 8px;"></i>
                <strong>Note:</strong> Deposit and interest calculations are finalized during association meetings, which may occur earlier or later than scheduled dates, affecting the timing of financial updates.
            </div>
        </div>

        
        <!-- Back to Admin -->
        <div class="back-to-admin">
            <a href="accounts.html">
                <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
            </a>
        </div>
    </div>

    <!-- Include the same scripts as your existing pages -->
    <script src="sheets-config.js"></script>
    <script src="sheets-utils.js"></script>
    
    <script>
        // Check admin access using accounts authentication
        (function() {
            console.log('Admin Reports - Checking accounts authentication...');
            
            // Check if user is authenticated through accounts
            var isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true' || localStorage.getItem('isAuthenticated') === 'true';
            
            if (!isAuthenticated) {
                console.log('User not authenticated, redirecting to login');
                alert('Please login to your account first.');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if user is president (only president has admin access)
            var userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
            var userRole = userDetails.role || '';
            var isAdmin = userRole === 'president';
            
            console.log('User role:', userRole, 'Is admin:', isAdmin);
            
            if (!isAdmin) {
                console.log('User is not admin, redirecting to accounts');
                alert('Access denied. Admin privileges required.');
                window.location.href = 'accounts.html';
                return;
            }
            
            console.log('Admin authentication successful, allowing access');
        })();
        
    </script>
    
    <script>
        let loansData = [];
        let depositsData = [];
        
        // Initialize the reports page
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });
        
        // Load all data using the same methods as your existing pages
        async function loadAllData() {
            try {
                console.log('Loading reports data...');
                
                // Load loans data using the same method as loans pages
                if (SHEETS_CONFIG && SHEETS_CONFIG.loansCsvUrl) {
                    const loansCsv = await SheetsUtils.fetchCsv(SHEETS_CONFIG.loansCsvUrl);
                    const loansRows = SheetsUtils.parseCsv(loansCsv);
                    loansData = SheetsUtils.rowsToObjects(loansRows);
                    console.log('Loans data loaded:', loansData.length, 'records');
                }
                
                // For deposits, we'll use the hardcoded data from your deposits pages
                // since deposits don't seem to have CSV data
                depositsData = getDepositsDataFromPages();
                console.log('Deposits data loaded:', depositsData.length, 'records');
                
                
                // Create simple deposits and interest chart
                createSimpleDepositsChart();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load data. Please try again later.');
            }
        }
        
        // Get deposits data from your existing pages structure
        function getDepositsDataFromPages() {
            // Based on your deposits pages, here's the structured data
            return [
                // 2021-22 Deposits
                { year: '2021-22', member: 'Manjunath Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Pratap Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Sarpabhushana Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Mukkanna Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Santosh Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Pradeep Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Praveen Banakar', amount: 5000, type: 'Initial', date: 'Feb-21' },
                { year: '2021-22', member: 'Manjunath Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Pratap Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Sarpabhushana Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Mukkanna Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Santosh Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Pradeep Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                { year: '2021-22', member: 'Praveen Banakar', amount: 1000, type: 'Monthly', date: 'Mar-21' },
                // Continue for all months... (simplified for example)
                { year: '2022-23', member: 'Manjunath Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Pratap Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Sarpabhushana Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Mukkanna Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Santosh Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Pradeep Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2022-23', member: 'Praveen Banakar', amount: 1500, type: 'Monthly', date: 'Mar-22' },
                { year: '2023-24', member: 'Manjunath Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Pratap Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Sarpabhushana Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Mukkanna Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Santosh Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Pradeep Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2023-24', member: 'Praveen Banakar', amount: 2000, type: 'Monthly', date: 'Mar-23' },
                { year: '2024-25', member: 'Manjunath Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Pratap Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Sarpabhushana Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Mukkanna Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Santosh Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Pradeep Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' },
                { year: '2024-25', member: 'Praveen Banakar', amount: 2000, type: 'Monthly', date: 'Mar-24' }
            ];
        }

        // Extract deposit analysis data from deposits.html account balance summary
        function getDepositAnalysisData() {
            // Updated data from deposits.html account balance summary table (as of latest)
            return [
                {
                    year: 'First Year (2021-2022)',
                    principalAmount: 111000,
                    interestEarned: 8700,
                    totalBalance: 114100,
                    months: '12 months'
                },
                {
                    year: 'Second Year (2022-2023)',
                    principalAmount: 149000,
                    interestEarned: 33600,
                    totalBalance: 169600,
                    months: '14 months'
                },
                {
                    year: 'Third Year (2023-2024)',
                    principalAmount: 159500,
                    interestEarned: 45700,
                    totalBalance: 187450,
                    months: '13 months'
                },
                {
                    year: 'Fourth Year (2024-2025)',
                    principalAmount: 126000,
                    interestEarned: 57300,
                    totalBalance: 149915,
                    months: '8 months'
                },
                {
                    year: 'Fifth Year (2025)',
                    principalAmount: 149000,
                    interestEarned: 103350,
                    totalBalance: 252350,
                    months: '11 months'
                }
            ];
        }
        
        
        // Create simple deposits and interest chart
        function createSimpleDepositsChart() {
            const ctx = document.getElementById('simpleDepositsChart').getContext('2d');
            const analysisData = getDepositAnalysisData();
            
            // Register the datalabels plugin
            Chart.register(ChartDataLabels);
            
            const labels = analysisData.map(data => data.year);
            const principalData = analysisData.map(data => data.principalAmount);
            const interestData = analysisData.map(data => data.interestEarned);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Principal Amount',
                            data: principalData,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: '#2E86C1',
                            borderWidth: 3,
                            borderRadius: 8,
                            borderSkipped: false,
                        },
                        {
                            label: 'Interest Earned',
                            data: interestData,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: '#E74C3C',
                            borderWidth: 3,
                            borderRadius: 8,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#007bff',
                            borderWidth: 2,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#2c3e50'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#2c3e50',
                                callback: function(value) {
                                    if (value >= 100000) {
                                        return '₹' + (value / 100000).toFixed(1) + 'L';
                                    } else if (value >= 1000) {
                                        return '₹' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            color: '#2c3e50',
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                if (context.datasetIndex === 0) { // Only show on principal amount bars (blue bars)
                                    const dataIndex = context.dataIndex;
                                    return analysisData[dataIndex].months;
                                }
                                return '';
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 5
                        }
                    }
                }
            });
        }
        
        
        // Show error message
        function showError(message) {
            const container = document.querySelector('.reports-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            container.insertBefore(errorDiv, container.firstChild);
        }

    </script>
</body>
</html>
