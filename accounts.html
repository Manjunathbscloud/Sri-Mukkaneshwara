<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Accounts - Sri Mukkanneshwara Associate</title>
    <link rel="stylesheet" href="styles.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
</head>
<body>
    <script>
        (function() {
            function hasValidUser() {
                var raw = sessionStorage.getItem('userDetails');
                if (!raw) return false;
                try { var u = JSON.parse(raw); return !!(u && u.id && u.name); } catch(e) { return false; }
            }
            
            function checkSessionTimeout() {
                var lastActivity = sessionStorage.getItem('lastActivity');
                var sessionStartTime = sessionStorage.getItem('sessionStartTime');
                
                // If no session data, allow login (don't force logout)
                if (!lastActivity || !sessionStartTime) {
                    // Set current time as session start and last activity
                    var now = Date.now();
                    sessionStorage.setItem('lastActivity', now.toString());
                    sessionStorage.setItem('sessionStartTime', now.toString());
                    return true;
                }
                
                var now = Date.now();
                var lastActivityTime = parseInt(lastActivity);
                var sessionStart = parseInt(sessionStartTime);
                
                // Update last activity on every check
                sessionStorage.setItem('lastActivity', now.toString());
                
                // Check for 60 minutes of inactivity (more lenient)
                var inactivityTimeout = 60 * 60 * 1000; // 60 minutes in milliseconds
                if (now - lastActivityTime > inactivityTimeout) {
                    return false;
                }
                
                // Check for total session time (24 hours max - very lenient)
                var totalSessionTimeout = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                if (now - sessionStart > totalSessionTimeout) {
                    return false;
                }
                
                return true;
            }
            
            var isAuth = sessionStorage.getItem('isAuthenticated') === 'true' && hasValidUser() && checkSessionTimeout();
            if (!isAuth) {
                // Clear all session data
                sessionStorage.clear();
                sessionStorage.setItem('returnUrl', window.location.href);
                window.location.href = 'login.html';
            }
        })();
    </script>

    <!-- Enhanced Session Management -->
    <!-- <script src="js/session-manager.js"></script> -->
    <header>
        <h1>Sri Mukkanneshwara Associate</h1>
        <nav>
            <ul>
                <li><a href="index.html">Overview</a></li>
                <li><a href="members.html">Members</a></li>
                <li><a href="accounts.html">Accounts</a></li>
                <li><a href="meetings.html">Meetings</a></li>
                <li><a href="rules.html">Rules</a></li>
            </ul>
        </nav>
        
        <!-- User Details in Top Right -->
        <div class="user-header-info" id="userHeaderInfo" style="display: none;">
            <div class="user-avatar-small">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-details-small">
                <span class="user-name" id="headerUserName">Loading...</span>
                <span class="user-role" id="headerUserRole">Loading...</span>
            </div>
            <div class="user-dropdown">
                <button class="user-menu-btn" onclick="toggleUserMenu()">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <a href="accounts.html"><i class="fas fa-user"></i> My Account</a>
                    <a href="#" id="logoutBtn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <h1>Sri Mukkanneshwara Associate</h1>
        <button class="mobile-nav-toggle" onclick="toggleMobileNav()">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-close" onclick="toggleMobileNav()">
            <i class="fas fa-times"></i>
        </button>
            <ul>
                <li><a href="index.html" onclick="toggleMobileNav()">Overview</a></li>
                <li><a href="members.html" onclick="toggleMobileNav()">Members</a></li>
                <li><a href="accounts.html" onclick="toggleMobileNav()">Accounts</a></li>
                <li><a href="meetings.html" onclick="toggleMobileNav()">Meetings</a></li>
                <li><a href="rules.html" onclick="toggleMobileNav()">Rules</a></li>
                <li><a href="#" id="mobileLogoutBtn" onclick="toggleMobileNav()" style="color: #e74c3c;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
    </div>

    <main>
        <!-- Page Loader -->
        <div id="pageLoader" class="page-loader" style="display: none;">
            <div class="spinner"></div>
        </div>
        
        <section class="account-overview mobile-dashboard">
            <div class="account-stats mobile-dashboard-grid">
                <div class="stat-card mobile-dashboard-card financial-summary">
                    <div class="financial-info">
                        <div class="financial-item">
                            <div class="stat-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Current Bank Balance</h4>
                                <span class="stat-value" id="bankBalance">₹1,83,790</span>
                            </div>
                        </div>
                        <div class="financial-item">
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Available Loan Amount</h4>
                                <span class="stat-value" id="availableLoanAmount">₹1,75,000</span>
                            </div>
                        </div>
                    </div>
                    <div class="financial-actions">
                        <button onclick="refreshFinancialData()" id="refreshBtn" class="refresh-btn" title="Refresh Financial Data">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i>
                            <div id="refreshLoader" style="display: none;">
                                <div class="spinner"></div>
                            </div>
                        </button>
                        <span class="stat-date" id="lastUpdated">As of September 15th 2025</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Account Services Section - Moved to top -->
        <section class="accounts-section">
            <h2 class="page-title">
                <i class="fas fa-university"></i> 
                Account Services
            </h2>

            <div class="services-container">
                <div class="service-card">
                    <h3><i class="fas fa-university"></i> Quick Access</h3>
                    <p>Access your deposits and loan information</p>
                    <div class="account-buttons">
                        <a href="deposits.html" class="account-btn">
                            <i class="fas fa-piggy-bank"></i>
                            Deposits
                        </a>
                        <a href="loans.html" class="account-btn">
                            <i class="fas fa-hand-holding-usd"></i>
                            Loans
                        </a>
                    </div>
                </div>

                <div class="service-card">
                    <h3><i class="fas fa-money-check-alt"></i> Loan Services</h3>
                    <p>Apply for loans or check your existing loan status</p>

                    <div class="action-buttons">
                        <button class="apply-loan-btn" onclick="window.location.href='loan-application.html'">
                            <i class="fas fa-hand-holding-usd"></i>
                            Apply for Loan
                        </button>
                        <button class="loan-status-btn" onclick="showLoanStatusMessage()">
                            <i class="fas fa-tools"></i>
                            Loan Status
                        </button>
                        <button class="view-loans-btn" onclick="window.location.href='president-view.html'">
                            <i class="fas fa-list-ul"></i>
                            View Loan Applications
                        </button>
                    </div>
                </div>

            </div>
        </section>

        <!-- Deposit History Section -->
        <section class="deposit-history">
            <div class="info-card history-summary compact">
                <h3><i class="fas fa-history"></i> Deposit Structure</h3>
                <div class="deposit-structure-grid">
                    <div class="structure-item">
                        <span class="period">2021-22</span>
                        <span class="amount">₹1,000/month</span>
                    </div>
                    <div class="structure-item">
                        <span class="period">2022-24</span>
                        <span class="amount">₹1,500/month</span>
                    </div>
                    <div class="structure-item current">
                        <span class="period">2025+</span>
                        <span class="amount">₹2,000/month</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Section - Only visible to admin users -->
        <section id="adminSection" class="admin-section" style="display: none;">
            <h2 class="page-title">
                <i class="fas fa-tachometer-alt"></i> 
                Admin Dashboard
            </h2>
            <p class="admin-subtitle">Manage all aspects of the Sri Mukkanneshwara Associate</p>

            <div class="admin-grid">
                <!-- Financial Management -->
                <div class="admin-card">
                    <div class="admin-card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Financial Management</h3>
                    <p>Update bank balance, available loan amounts, and send notifications to all members about financial changes.</p>
                    <a href="admin-financial.html" class="admin-btn">
                        <i class="fas fa-edit"></i> Update Financial Data
                    </a>
                </div>
                
                <!-- Loan Applications -->
                <div class="admin-card">
                    <div class="admin-card-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h3>Loan Applications</h3>
                    <p>Review and manage loan applications submitted by members. Accept or reject applications as needed.</p>
                    <a href="president-view.html" class="admin-btn">
                        <i class="fas fa-eye"></i> Review Applications
                    </a>
                </div>
                
                <!-- Reports & Analytics -->
                <div class="admin-card">
                    <div class="admin-card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3>Reports & Analytics</h3>
                    <p>Generate comprehensive reports on loans, deposits, financial status, and member activities with interactive charts and graphs.</p>
                    <a href="admin-reports.html" class="admin-btn">
                        <i class="fas fa-chart-line"></i> View Analytics
                    </a>
                </div>
                
                <!-- Member Management -->
                <div class="admin-card">
                    <div class="admin-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Member Management</h3>
                    <p>View member information, manage member roles, and access member-related data and reports.</p>
                    <a href="members.html" class="admin-btn">
                        <i class="fas fa-user-cog"></i> Manage Members
                    </a>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Sri Mukkanneshwara Associate. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is president (only president has admin access)
            const userDetails = JSON.parse(sessionStorage.getItem('userDetails') || localStorage.getItem('userDetails') || '{}');
            const userRole = userDetails.role || '';
            const isAdmin = userRole === 'president';
            
            console.log('User role:', userRole, 'Is admin:', isAdmin);
            
            // User details are now displayed in the header with member images
            
            // Show admin section if user is president
            const adminSection = document.getElementById('adminSection');
            if (isAdmin && adminSection) {
                adminSection.style.display = 'block';
                console.log('Admin section displayed for user:', userDetails.name);
            }

        });

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobileNav');
            const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
            
            if (!mobileNav.contains(event.target) && !mobileNavToggle.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Role-based access control (simplified - no admin tools in accounts page)
        function checkUserRole() {
            try {
                const userDetails = JSON.parse(localStorage.getItem('userDetails') || sessionStorage.getItem('userDetails') || '{}');
                const userRole = userDetails.role || userDetails.position || '';
                console.log('User role detected:', userRole);
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }

        // User details are now displayed in the header with member images

        // Check role when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkUserRole();
            initializeSessionManagement();
        });

        // Session Management Functions
        function initializeSessionManagement() {
            // Update last activity on any user interaction
            function updateLastActivity() {
                sessionStorage.setItem('lastActivity', Date.now().toString());
            }

            // Track user activity
            ['click', 'keypress', 'scroll', 'mousemove', 'touchstart'].forEach(function(event) {
                document.addEventListener(event, updateLastActivity, true);
            });

            // Check session timeout every 5 minutes (less frequent)
            setInterval(function() {
                var lastActivity = sessionStorage.getItem('lastActivity');
                var sessionStartTime = sessionStorage.getItem('sessionStartTime');
                
                if (!lastActivity || !sessionStartTime) {
                    // Only redirect if we're sure the session is invalid
                    if (sessionStorage.getItem('isAuthenticated') !== 'true') {
                        sessionStorage.clear();
                        window.location.href = 'login.html';
                    }
                    return;
                }
                
                var now = Date.now();
                var lastActivityTime = parseInt(lastActivity);
                var sessionStart = parseInt(sessionStartTime);
                
                // Check for 30 minutes of inactivity (increased from 15)
                var inactivityTimeout = 30 * 60 * 1000; // 30 minutes
                if (now - lastActivityTime > inactivityTimeout) {
                    alert('Session expired due to inactivity. Please login again.');
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
                
                // Check for total session time (8 hours max - increased from 4)
                var totalSessionTimeout = 8 * 60 * 60 * 1000; // 8 hours
                if (now - sessionStart > totalSessionTimeout) {
                    alert('Session expired. Please login again.');
                    sessionStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
            }, 300000); // Check every 5 minutes instead of every minute

            // Handle browser close/refresh - only clear on actual browser close
            var isNavigating = false;
            
            // Track internal navigation
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'A' || e.target.closest('a')) {
                    isNavigating = true;
                }
            });
            
            window.addEventListener('beforeunload', function(e) {
                // Only clear session if it's not internal navigation
                if (!isNavigating) {
                    sessionStorage.clear();
                }
            });

            // Handle page visibility change (tab switching)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Page is hidden, update last activity
                    updateLastActivity();
                }
            });
        }

        // Refresh financial data with loader
        function refreshFinancialData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshLoader = document.getElementById('refreshLoader');
            
            // Show loader
            refreshBtn.disabled = true;
            refreshIcon.style.display = 'none';
            refreshLoader.style.display = 'inline-block';
            
            // Call refresh function
            if (window.FinancialData && window.FinancialData.refresh) {
                window.FinancialData.refresh();
            }
            
            // Hide loader after a delay
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshIcon.style.display = 'inline';
                refreshLoader.style.display = 'none';
            }, 2000);
        }

        // Loan Status Button Function
        function showLoanStatusMessage() {
            alert('Loan Status feature is under development. Coming soon!');
        }
    </script>

    <!-- Financial Data Management -->
    <script src="financial-data.js"></script>
    
    <!-- User Header Script -->
    <script src="js/user-header.js"></script>

</body>
</html>
